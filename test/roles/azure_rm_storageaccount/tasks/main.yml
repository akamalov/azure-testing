 - name: Create resource group
   azure_rm_resourcegroup:
       name: "{{ resource_group }}"
       location: westus
       
 - name: Test invalid account name
   azure_rm_storageaccount:
       resource_group: "{{ resource_group }}" 
       name: "invalid_char$"
       state: present
   register: invalid_name     
   ignore_errors: yes  

 - name: Assert task failed
   assert: { that: "invalid_name['failed'] == True" }

 - name: Delete storage account
   azure_rm_storageaccount:
       resource_group: "{{ resource_group }}" 
       name: teststorageacct001
       state: absent
       debug: "{{ playbook_debug }}"
       log_mode: file 
   register: output

 - debug: var=output
   when: playbook_debug

 - name: Create new storage account
   azure_rm_storageaccount:
       resource_group: "{{ resource_group }}" 
       name: teststorageacct001
       account_type: Standard_LRS
       debug: "{{ playbook_debug }}" 
       log_mode: file
       tags:
           test: test
           galaxy: galaxy
   register: output

 - debug: var=output
   when: playbook_debug

 - name: Assert status succeeded and results include an Id value 
   assert:
     that:
       - output.changed
       - output.results.id is defined

 - name: Change account type 
   azure_rm_storageaccount:
       resource_group: "{{ resource_group }}" 
       name: teststorageacct001
       account_type: Premium_LRS
   register: change_account
   ignore_errors: yes 

 - debug: var=change_account
   when: playbook_debug

 - name: Assert account type change failed 
   assert: { that: "change_account['failed'] == True" }

 - name: Change account type and add custom domain
   azure_rm_storageaccount:
       resource_group: "{{ resource_group }}" 
       name: teststorageacct001
       account_type: Standard_GRS
       custom_domain:
           name: "ansible.com"
           use_sub_domain: no  
       debug: "{{ playbook_debug }}" 
       log_mode: file
   register: change_account
   ignore_errors: yes

 - name: Debug
   debug: var=change_account
   when: playbook_debug

 - name: Assert CNAME failure
   assert: { that: "'custom domain name could not be verified' in  change_account['msg']" }

 - name: Update account tags
   azure_rm_storageaccount:
       resource_group: "{{ resource_group }}"
       name: teststorageacct001
       debug: "{{ playbook_debug }}"
       log_mode: file
       tags:
           testing: testing
           delete: never
           galaxy: 'no'
   register: output

 - debug: var=output
   when: playbook_debug

 - assert:
       that:
           - "output.results.tags | length == 4"
           - "output.results.tags.galaxy == 'no'"

 - name: Update account tags
   azure_rm_storageaccount:
       resource_group: "{{ resource_group }}"
       name: teststorageacct001
       debug: "{{ playbook_debug }}"
       log_mode: file
       tags:
           testing: testing
           delete: never
       purge_tags: yes
   register: output

 - debug: var=output
   when: playbook_debug

 - assert:
       that:
           - "output.results.tags | length == 2"
           - "output.results.tags.testing == 'testing'"
           - "output.results.tags.delete == 'never'"

 - name: Gather facts
   azure_rm_storageaccount_facts:
       resource_group: "{{ resource_group }}"
       name: teststorageacct001
   register: output

 - debug: var=output
   when: playbook_debug

 - assert:
       that:
           - "output.results | length == 1"

 - name: Gather facts
   azure_rm_storageaccount_facts:
       resource_group: "{{ resource_group }}"
   register: output

 - debug: var=output
   when: playbook_debug

 - assert:
       that:
           - "output.results | length > 0"

 - name: Delete acccount
   azure_rm_storageaccount:
       resource_group: "{{ resource_group }}" 
       name: teststorageacct001
       state: absent
       debug: "{{ playbook_debug }}" 
       log_mode: file
   register: output

 - debug: var=output
   when: playbook_debug
