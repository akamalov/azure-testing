- name: Test azure_rm_virtualmachine using default NIC, PIP, Security Group and Storage Account
  hosts: all
  connection: local
  vars:
      resource_group : Testing
      playbook_debug: yes
      remove_vm: no
      ssh_keys:
          - path: '/home/chouseknecht/.ssh/authorized_keys'
            key_data: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC1igsIlcmTa/yfsJnTtnrEX7PP/a01gwbXcig6JOKyrUmJB8E6c/wtZwP115VSyDRTO6TEL/sBFUpkSw01zM8ydNATErh8meBlAlbnDq5NLhDXnMizgG0VNn0iLc/WplFTqkefsHXa8NtIxAtyEVIj/fKbK3XfBOdEpE3+MJYNtGlWyaod28W+5qmQPZDQys+YnE4OjSwN7D3g85/7dtLFvDH+lEC4ooJOaxVFr9VSMXUIkaRF6oI+R1Zu803LFSCTb4BfFOYOHPuQ/rEMP0KuUzggvP+TEBY14PEA2FoHOn+oRsT0ZR2+loGRaxSVqCQKaEHbNbkm+6Rllx2NQRO0BJxCSKRU1iifInLPxmSc4gvsHCKMAWy/tGkmKHPWIfN8hvwyDMK5MNBp/SJ1pVx4xuFDQjVWNbll0yk2+72uJgtFHHwEPK9QsOz45gX85vS3yhYCKrscS/W9h2l36SWwQXuGy4fXotE7esPsvNGAzBndHX1O8RMPg47qJXz059RyoGforoa9TnzIs3hIv+ts7ESx3OEq3HNk0FJ+wDka7IM7WQpGrVToJ0vfDy9Q46nw54vv5Zc/u4OZF3F5twHmyf3rLYKXRDuCvZQKT2iWQKVX6j63bq6orA5hwl22zndxWZNtOwtq8Sd0Ns0K/Fo/ggYDDGBtr68DwhA+MrxrHw== chouseknecht@ansible.com"
      image:
          offer: CentOS
          publisher: OpenLogic
          sku: '7.1'
          version: latest
  tasks:
      - name: Remove VM
        azure_rm_virtualmachine:
            resource_group: "{{ resource_group }}"
            name: testvm10
            state: absent
        register: output
        when: remove_vm

      - debug: var=output
        when: playbook_debug
        
      - name: Create VM with defaults
        azure_rm_virtualmachine:
            resource_group: "{{ resource_group }}"
            name: testvm10
            vm_size: Standard_D1
            admin_username: chouseknecht
            admin_password: Password123!
            short_hostname: test10
            os_type: Linux
            image: "{{ image }}"
            debug: "{{ playbook_debug }}"
            log_mode: file
            state: present
        register: output

      - debug: var=output
        when: playbook_debug

      - name: Create VM accessible via ssh keys only 
        azure_rm_virtualmachine:
            resource_group: "{{ resource_group }}"
            name: testvm20
            short_hostname: testvm20
            ssh_password: false    
            ssh_public_keys: "{{ ssh_keys }}"
            vm_size: Standard_D1
            admin_username: chouseknecht
            image: "{{ image }}"
            debug: "{{ playbook_debug }}"
            state: present
            log_mode: file

      - name: Power Off 
        azure_rm_virtualmachine:
            resource_group: "{{ resource_group }}"
            name: testvm10
            state: stopped
            debug: "{{ playbook_debug }}"
            log_mode: file
        register: output

      - assert:
            that: output.results.power_state != 'running'

      - debug: var=output
        when: playbook_debug

      - name: Power On
        azure_rm_virtualmachine:
            resource_group: "{{ resource_group }}"
            name: testvm10
            state: started
            debug: "{{ playbook_debug }}"
            log_mode: file
        register: output
             
      - assert:
            that: output.results.power_state == 'running'
