---
- name: Test azuzre_rm_storageaccount
  hosts: localhost
  vars:
      debug_playbook: yes
      new_account_name: "mystorage{{ 100 |random }}"
      resource_group: Testing 
  tasks:

     - name: Test invalid account name
       azure_rm_storageaccount:
           resource_group: "{{ resource_group }}" 
           name: "invalid_char$"
           state: present
       register: invalid_name     
       ignore_errors: yes  

     - name: Assert task failed
       assert: { that: "invalid_name['failed'] == True" }

     - name: Delete storage account
       azure_rm_storageaccount:
           resource_group: "{{ resource_group }}" 
           name: "{{ new_account_name }}"
           state: absent
           debug: "{{ debug_playbook }}"
           log_mode: file 
       register: test_004

     - debug: var=test_004
       when: debug_playbook

     - name: Create new storage account
       azure_rm_storageaccount:
           resource_group: "{{ resource_group }}" 
           name: "{{ new_account_name }}"
           location: eastus
           account_type: Standard_LRS
           debug: "{{ debug_playbook }}" 
           log_mode: file
           tags:
               test: test
               galaxy: galaxy
       register: test_005
 
     - name: Debug
       debug: var=test_005
       when: debug_playbook

     - name: Assert status succeeded and results include an Id value 
       assert:
         that:
           - test_005.changed
           - test_005.results.id is defined

     - name: Change account type 
       azure_rm_storageaccount:
           resource_group: "{{ resource_group }}" 
           name: "{{ test_005['name'] }}"
           account_type: Premium_LRS
       register: change_account
       ignore_errors: yes 
  
     - name: Assert account type change failed 
       assert: { that: "change_account['failed'] == True" }

     - name: Change account type and add custom domain
       azure_rm_storageaccount:
           resource_group: "{{ resource_group }}" 
           name: "{{ test_005['name'] }}"
           account_type: Standard_GRS
           custom_domain:
               name: "ansible.com"
               use_sub_domain: no  
           debug: "{{ debug_playbook }}" 
           log_mode: file
       register: change_account
       ignore_errors: true

     - name: Debug
       debug: var=change_account
       when: debug_playbook

     - name: Assert CNAME failure
       assert: { that: "'custom domain name could not be verified' in  change_account['msg']" }

     - name: Delete acccounts - anything not in use will be deleted
       azure_rm_storageaccount:
           resource_group: "{{ resource_group }}" 
           name: "{{ item['name'] }}"
           state: absent
           debug: "{{ debug_playbook }}" 
           log_mode: file
       with_items: "{{ gathered_list['storage_accounts'] }}"
