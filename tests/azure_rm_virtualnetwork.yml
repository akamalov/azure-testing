- name: Test azure_rm_virtualnetwork
  hosts: all
  connection: local
  vars:
      playbook_debug: yes
      resource_group: Testing
  tasks:
      - name: Delete virtual network, if it exists
        azure_rm_virtualnetwork:
          name: my_test_network
          resource_group: "{{ resource_group }}"
          state: absent
          debug: "{{ playbook_debug }}"
          log_mode: file
        register: output

      - debug: var=output
        when: playbook_debug 

      - name: Create virtual network  
        azure_rm_virtualnetwork:
          name: my_test_network
          location: eastus
          address_prefixes_cidr: 
            - 10.1.0.0/16
            - 172.100.0.0/16
          dns_servers:
            - 127.0.0.1
            - 127.0.0.3
          tags:
            testing: testing
            delete: on-exit
          resource_group: "{{ resource_group }}"
          debug: "{{ playbook_debug }}"
          log_mode: file
        register: output

      - debug: var=output
        when: playbook_debug

      - assert:
          that: 
            - "output.results.address_prefixes | length == 2" 
            - "output.results.dns_servers | length == 2" 
            - "output.results.tags.delete == 'on-exit'"

      - name: Should require address_prefixes_cidr when purge_address_prefixes
        azure_rm_virtualnetwork:
          name: my_test_network
          purge_address_prefixes: true
          resource_group: "{{ resource_group }}"
          debug: "{{ playbook_debug }}"
          log_mode: file
        register: output
        ignore_errors: yes

      - debug: var=output
        when: playbook_debug
   
      - assert:
            that: output.failed

      - name: Purge address prefixes 
        azure_rm_virtualnetwork:
          name: my_test_network
          address_prefixes_cidr:
            - 10.1.0.0/16
          purge_address_prefixes: true
          resource_group: "{{ resource_group }}"
          debug: "{{ playbook_debug }}"
          log_mode: file
        register: output

      - debug: var=output
        when: playbook_debug

      - assert:
            that:
                - output.results.address_prefixes | length == 1
                - output.results.address_prefixes[0] == '10.1.0.0/16'
                - output.results.dns_servers | length == 2
                - output.results.dns_servers[0] == '127.0.0.1'

      - name: Purge DNS servers 
        azure_rm_virtualnetwork:
          name: my_test_network
          purge_dns_servers: true
          resource_group: "{{ resource_group }}"
          debug: "{{ playbook_debug }}"
          log_mode: file
        register: output

      - debug: var=output
        when: playbook_debug

      - assert:
            that: output.results['dns_servers'] is undefined
