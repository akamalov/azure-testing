- name: Test azure_rm_subnet
  hosts: all
  vars:
    playbook_debug: yes
  tasks:
    - name: Remove subnet
      azure_rm_subnet:
        state: absent
        name: foobar 
        virtual_network_name: My_Virtual_Network
        resource_group: testing
        debug: "{{ playbook_debug }}"
      register: output 
   
    - debug: var=output
      when: playbook_debug 

    - name: Catch invalid cidr  
      azure_rm_subnet:
        name: foobar
        virtual_network_name: My_Virtual_Network
        resource_group: Testing  
        address_prefix_cidr: "10.1.0/24"
        debug: "{{ playbook_debug }}"
      register: output
      ignore_errors: yes

    - debug: var=output
      when: playbook_debug
 
    - assert:
        that: output.failed

    - name: Add the subnet back
      azure_rm_subnet:
        name: foobar
        virtual_network_name: My_Virtual_Network
        resource_group: Testing  
        address_prefix_cidr: "10.1.0.0/24"
        debug: "{{ playbook_debug }}"
      register: output

    - debug: var=output
      when: playbook_debug
    
    - assert:  
        that: output.changed

    - name: Should be idempotent 
      azure_rm_subnet:
        name: foobar
        virtual_network_name: My_Virtual_Network
        resource_group: Testing  
        address_prefix_cidr: "10.1.0.0/24"
        debug: "{{ playbook_debug }}"
      register: output

    - debug: var=output
      when: playbook_debug

    - assert:
        that: not output.changed

